{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatGPT UI Clone</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- For code and tables -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>


<!-- Comic Neue font -->
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">

<!-- Script for Latex code -->
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  svg: { fontCache: 'global' }
};
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


    <style>
        :root {
            --primary-bg: #343541;
            --secondary-bg: #202123;
            --accent: rgb(49, 49, 50);
            --hover-bg: #2a2b32;
            --text: #ffffff;
            --chat-bg: #444654;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text);
        }

        /* --------- whole container --------- */
        .app-wrapper {
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

    /* --------- sidebar --------- */
        .sidebar {
            background-color: var(--secondary-bg);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-toggle:hover,
        .chat-history-item:hover,
        .icon-btn:hover {
            background-color: var(--hover-bg);
        }

        .chat-history-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 80%;
        }

        .sidebar-scroll {
            overflow-y: auto;
            height: calc(100% - 3.5rem);
        }

        .chat-history::-webkit-scrollbar {
            height: 6px;
        }

        .action-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--secondary-bg);
            border: 1px solid #444;
            z-index: 50;
        }

        .action-menu button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            width: 100%;
            text-align: left;
        }

        .action-menu button:hover {
            background-color: var(--hover-bg);
        }

        .chat-history-item:hover .more-btn {
            display: inline;
        }

        /* Add to existing styles */
        .sidebar .chat-history-item .more-btn {
            visibility: hidden;
        }

        .sidebar .chat-history-item:hover .more-btn {
            visibility: visible;
        }

        /* Action Menu always fully visible */
        .action-menu {
            min-width: 8rem;
            z-index: 9999;
        }

        /* Sidebar toggle button styles */
        .sidebar-toggle-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .sidebar-toggle-btn.active {
            left: calc(16rem + 1rem);
            /* sidebar width + padding */
        }

        #sidebarCloseBtn {
            z-index: 101;
        }

        .sidebar-closed #newChatBtn {
            margin-left: 2.5rem;
        }

        .sidebar img,
        #mainContent img {
            max-height: 2rem;
        }

    /* --------- right to sidebar (where all content present) --------- */
        .main-content {
            transition: margin-left 0.3s ease;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .main-content.shifted {
            margin-left: 16rem;
        }

        @media (max-width: 640px) {
            .sidebar-toggle-btn.active {
                left: calc(100% - 3rem);
            }

            .main-content.shifted {
                margin-left: 0;
            }
        }




        /* Chat wrapper holds the nav, chat area, and input */
        #chatWrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        /* NEW: Main scroll area between navbar and input */
        #chatMessages {
            flex: 1;
            width: 100%;
        }

        .content-container {
            max-width: 64rem;
            width: 100%;
            margin: 10px auto;
            padding: 0 1rem;
        }


        /* Chat bubble styles */
        .chat-message {
            border-radius: 0.75rem;
            word-break: break-word;
            margin-bottom: 0.5rem;
            width: fit-content;
            max-width: 70%;
        }


        .chat-user {
            padding: 0.75rem 1rem;
            align-self: flex-end;
            background-color: var(--accent);
            color: white;
            margin-left: auto;
            margin-right: 0;
            white-space: pre-wrap;
            /* ✅ Preserves user formatting */
        }

        .chat-gpt {
            padding: 0rem 1rem;
            align-self: flex-start;
            background-color: transparent;
            color: white;
            max-width: 100%;
            width: auto;
        }


        .msg-container-box::-webkit-scrollbar {
            width: 6px;
        }

        .msg-container-box::-webkit-scrollbar-thumb {
            background-color: #666;
            border-radius: 3px;
        }

        .chat-input-wrapper {
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg);
            border: 1px solid #444;
            border-radius: 0.75rem;
            padding: 0.75rem;
            gap: 0.5rem;
            max-width: 100%;
            box-sizing: border-box;
        }


        .chat-textarea {
            resize: none;
            outline: none;
            border: none;
            background-color: transparent;
            color: white;
            font-size: 1rem;
            line-height: 1.5;
            max-height: 128px;
            overflow-y: auto;
            padding: 0.5rem;
            width: 100%;
            scrollbar-width: thin;
            scrollbar-color: #555 transparent;
            vertical-align: top;

        }


        textarea:focus {
            outline: none;
            box-shadow: none;
        }


        textarea::-webkit-scrollbar {
            width: 2px;
        }



        .chat-icons {
            display: flex;
            justify-content: space-between;
            padding: 0rem;
        }

        .chat-icons button {
            background: none;
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .chat-icons button:hover {
            background-color: var(--hover-bg);
        }

        /* ----------------------------- */
  /* Add these styles to your existing CSS */

.markdown-body {
    color: #e6e6e6;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    line-height: 1.5;
    word-wrap: break-word;
    letter-spacing: 0.2px;
}

/* Headers */
.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
    margin: 1.5em 0 0.5em;
    font-weight: 600;
    color: #ffffff;
    line-height: 1.3;
}

.markdown-body h1 { font-size: 1.8em; border-bottom: 2px solid #4d4d4d; padding-bottom: 0.3em; }
.markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #4d4d4d; padding-bottom: 0.2em; }
.markdown-body h3 { font-size: 1.3em; }
.markdown-body h4 { font-size: 1.15em; }
.markdown-body h5 { font-size: 1em; }
.markdown-body h6 { font-size: 0.9em; color: #aaaaaa; }

/* paragraphs */
.markdown-body p {
    margin: 1em 0;
    line-height: 1.6;
    color: #e0e0e0;
}

/* Lines */
.markdown-body hr {
    border: none;
    border-top: 1px solid #555;
    margin: 2em 0;
}


/* Improved code block styling */
.markdown-body pre {
    background-color: #1e1e1e !important;
    padding: 0px;
    overflow: auto;
    position: relative;
    border-bottom-left-radius: 6px;
    border-bottom-right-radius: 6px;

}

.markdown-body code {
    background-color: rgba(30, 30, 30, 0.6);
    border-radius: 3px;
    padding: 0.2em 0.4em;
    font-size: 85%;
    font-family: 'Consolas', 'Monaco', 'Andale Mono', monospace;
}

.markdown-body pre code {
    background: transparent;
    padding: 0;
    border-radius: 0;
    display: block;
    overflow-x: auto;
}

/* Inline Code */
.markdown-body p code,
.markdown-body li code {
    background-color: #2b2b2b;
    color: #ffcb6b;
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-family: 'Consolas', monospace;
}



/* code blocks color */
.hljs {
    padding: 1em !important;
    border-radius: 4px !important;
    background: #1e1e1e !important;
    color: #d4d4d4 !important;
}

/* Syntax colors */
.hljs-keyword { color: #569cd6 !important; }          /* Blue - keywords */
.hljs-built_in { color: #4ec9b0 !important; }        /* Teal - built-ins/types */
.hljs-type { color: #4ec9b0 !important; }            /* Teal - types */
.hljs-literal { color: #569cd6 !important; }         /* Blue - literals */
.hljs-number { color: #b5cea8 !important; }          /* Green - numbers */
.hljs-string { color: #ce9178 !important; }          /* Orange - strings */
.hljs-comment { color: #6a9955 !important; }         /* Green - comments */

/* Function-related elements */
.hljs-function { color: #dcdcaa !important; }        /* Light yellow - function keyword */
.hljs-title { color: #dcdcaa !important; }           /* Light yellow - function names */

/* Parameters and variables - made consistent */
.hljs-params { color: #9cdcfe !important; }          /* Light blue - parameters in definition */
.hljs-variable { color: #9cdcfe !important; }        /* Light blue - variables (including param usage) */
.hljs-attr { color: #9cdcfe !important; }            /* Light blue - attributes */

/* Other elements */
.hljs-tag { color: #569cd6 !important; }             /* Blue - tags */
.hljs-name { color: #569cd6 !important; }            /* Blue - tag names */
.hljs-meta { color: #9cdcfe !important; }            /* Light blue - meta */
.hljs-subst { color: #d4d4d4 !important; }           /* Default text color */




/* Scrollable wrapper for tables */
.table-scroll-wrapper {
    overflow-x: auto;
    max-width: 100%;
    display: block;
    margin: 1em 0;

    position: relative;
}

        .table-scroll-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .table-scroll-wrapper::-webkit-scrollbar-thumb {
            background-color: #666;
            border-radius: 3px;
        }


/* Table must be wider than container to force scroll */
.markdown-body table {
    width: max-content;
    min-width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
    table-layout: auto;
}


/* Cells */
.markdown-body table th,
.markdown-body table td {
    padding: 6px 13px;
    border: 1px solid #4d4d4d;
    white-space: initial; /* prevent wrapping */

    overflow-wrap: break-word;
    word-break: break-word;
    max-width: 250px; /* ✅ Limit to force wrap if too long */

    vertical-align: top;
}

/* Styling */
.markdown-body table tr {
    background-color: #2d2d2d;
}
.markdown-body table tr:nth-child(2n) {
    background-color: #252525;
}
.markdown-body table th {
    background-color: #3a3a3a;
    font-weight: bold;

    white-space: normal;  /* allow header text to wrap */
}


@media (max-width: 600px) {
    .markdown-body table th,
    .markdown-body table td {
        max-width: 200px; 
    }
}



.markdown-body blockquote {
    border-left: 4px solid #4d4d4d;
    color: #b3b3b3;
    padding: 0 1em;
    margin: 0 0 1em 0;
}

.markdown-body ul,
.markdown-body ol {
    padding-left: 2em;
    margin-bottom: 1em;
    margin: 1em 0;
}

/* Fix for lists */
.markdown-body ul {
    list-style-type: disc;
}

.markdown-body ol {
    list-style-type: decimal;
}

.markdown-body li {
    margin-bottom: 0.5em;
    position: relative;
    display: list-item; /* Ensure this is set */
}

/* Fix for nested lists */
.markdown-body ul ul, 
.markdown-body ol ul {
    list-style-type: circle;
}

.markdown-body ol ol, 
.markdown-body ul ol {
    list-style-type: lower-roman;
}

/* Spacing Between Elements */
.markdown-body > *:not(:last-child) {
    margin-bottom: 1em;
}


.copy-code-btn,  .copy-table-btn  {
    position: absolute;
    right: 8px;
    top: 8px;
    background: #4d4d4d;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
    opacity: 1;  /* always visible */
    transition: opacity 0.3s;
    z-index: 10;
}


mjx-container {
    display: block;
    margin: 1em 0;
    font-size: 1.2em;
    text-align: center;
}


  /* Copy button styles */
    .copy-btn-container {
        display: flex;
    }

    

.copy-btn-container.right {
    justify-content: flex-end;
}

.copy-btn-container.left {
    justify-content: flex-start;
}

    .copy-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 4px;
        margin-left: 15px;
        border-radius: 4px;
        color: #d1d5db;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .copy-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
    
    .copy-btn svg {
        width: 16px;
        height: 16px;
    }
    
    .copy-btn.copied {
        color: #10b981;
    }
    

    .loader-dots {
    display: inline-flex;
    align-items: center;
    justify-content: flex-start;
    height: 1.5rem;
    padding: 1rem 0;
}

.loader-dots span {
    width: 6px;
    height: 6px;
    margin: 0 2px;
    border-radius: 50%;
    background-color: #ccc;
    animation: blink 1.4s infinite both;
}

.loader-dots span:nth-child(2) {
    animation-delay: 0.2s;
}
.loader-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes blink {
    0%, 80%, 100% {
        opacity: 0;
    }
    40% {
        opacity: 1;
    }
}

</style>


<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <!-- Copy icon -->
    <symbol id="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </symbol>
    <!-- Check icon -->
    <symbol id="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
    </symbol>
</svg>



</head>

<body>
    <div class="app-wrapper">
        <!-- Sidebar Toggle Button -->
        <button id="sidebarToggleBtn" class="sidebar-toggle-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>

        <!-- Whole container -->
        <div class="flex h-full">
            <!-- Sidebar -->
            <div id="sidebar" class="sidebar w-64 p-4 space-y-4 h-full overflow-hidden fixed top-0 left-0 z-40">
                <div class="flex flex-col h-full overflow-hidden">
                    <div class="flex justify-between items-center mb-2">
                        <img src="{% static 'images/logo_scaledge.png' %}" alt="Logo" class="h-7 w-auto" />
                        <button id="sidebarCloseBtn"
                            class="p-2 rounded-md hover:bg-gray-600 absolute top-4 right-4 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                    <button class="w-full text-left p-2 rounded sidebar-toggle">
                        + New Chat
                    </button>
                    <input id="chatSearch" type="text" placeholder="Search chats"
                        class="w-full p-2 mt-2 rounded bg-gray-700 text-white" />

                    <!-- Scrollable Content -->
                    <div id="chatHistory" class="mt-4 space-y-2 overflow-y-auto flex-1 pr-2">
                        <div class="relative chat-history-item p-2 rounded cursor-pointer flex justify-between items-center group"
                            title="Dummy Chat 1">
                            <span>Dummy Chat 1</span>
                            <button class="text-white more-btn">⋯</button>
                            <div
                                class="action-menu hidden bg-gray-800 text-white text-sm rounded shadow-lg absolute right-0 top-full mt-1 z-50 w-36">
                                <button class="rename-chat"><span>✏️</span> Rename</button>
                                <button class="delete-history"><span>🗑️</span> Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div id="mainContent" class="main-content flex-1 flex flex-col min-h-0">
                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-700">
                    <div class="flex items-center space-x-4">
                        <button id="newChatBtn" class="icon-btn p-2 rounded">
                            + New Chat
                        </button>

                       <div class="flex relative items-center gap-2 sm:flex">
                            <span class="font-bold text-xl mr-3">VeriAssist</span>
                            <img src="{% static 'images/logo_scaledge.png' %}" alt="scaledge Logo" class="h-6 w-auto absolute right-0 mb-2" />
                        </div> 


                    </div>
                    <div class="flex items-center space-x-4">
                        <button class="icon-btn p-2 rounded">🔗 Share</button>
                        <button id="deleteChat" class="icon-btn p-2 rounded">
                            🗑️ Delete
                        </button>
                        <div class="w-8 h-8 rounded-full bg-gray-500">
                            <img src="{% static 'images/profile_logo.png' %}" alt="profile icon"  /> 
                        </div>
                    </div>
                </div>

                <!-- After top navbar -->
                <!-- Chat Section -->
                <div id="chatWrapper" class="flex-1 flex flex-col h-full relative">
                    <!-- Initially centered welcome & chatbox -->

                    <div id="initialChatSection"
                        class="flex flex-col items-center justify-center text-center h-full space-y-6 px-4">
                        <div>

                            <div class="flex items-center relative justify-center gap-2 mb-2">
                                <h1 class="text-3xl font-semibold mr-3">Explore VeriAssist</h1>
                                <img src="{% static 'images/logo_scaledge.png' %}" alt="scaledge Logo" class="h-10 w-auto absolute right-0 mb-3" />
                            </div>



                            <p class="text-sm text-gray-400">
                                Start a new conversation by typing below.
                            </p>
                        </div>

                        <!-- Centered input -->
                        <div class="w-full max-w-4xl mx-auto p-4">
                            <div class="chat-input-wrapper">

                                <!-- Textarea center -->
                                <textarea id="chatInput" rows="1" placeholder="Type your message..."
                                    class="chat-textarea"></textarea>

                                <div class="chat-icons">
                                    <!-- Upload button left -->
                                    <button id="uploadIconCenter">📎</button>
                                    <button id="submitMessage">➡️</button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Scrollable chat and fixed bottom input -->
                    <div id="chatContainer" class="hidden flex-1 flex flex-col h-full">

                        <!-- Chat messages -->
                        <div class="msg-container-box flex-1 overflow-y-auto w-full" id="msg-container-box">
                            <!-- Msg displayed here -->
                            <div id="chatMessages" class="content-container"></div>
                        </div>


                        <!-- Fixed input at bottom -->
                        <div class="content-container pb-4 bg-[#343541]">
                            <div class="chat-input-wrapper">

                                <!-- Textarea center -->
                                <textarea id="newChatInput" rows="1" placeholder="Type your message..."
                                    class="chat-textarea"></textarea>
                                <div class="chat-icons">
                                    <button id="uploadIconBottom">📎</button>
                                    <button id="sendMessage">➡️</button>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>

    <script>

// Track scroll position
let userScrolledUp = false;
let lastScrollPosition = 0;

        let isUserInteractingWithScroll = false;
        let scrollInteractionTimeout;

        // Auto-scroll observer
        function setupAutoScroll() {
            const chatContainer = document.getElementById('msg-container-box');
            
            chatContainer.addEventListener('scroll', () => {
                const scrollThreshold = 100; // pixels from bottom
                const isNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < scrollThreshold;
                
                // Clear any existing timeout
                clearTimeout(scrollInteractionTimeout);
                
                // User is actively scrolling
                isUserInteractingWithScroll = true;
                
                // Set a timeout to reset the flag after scrolling stops
                scrollInteractionTimeout = setTimeout(() => {
                    isUserInteractingWithScroll = false;
                }, 1000);
                
                if (!isNearBottom) {
                    userScrolledUp = true;
                } else {
                    userScrolledUp = false;
                }
                
                lastScrollPosition = chatContainer.scrollTop;
            });
        }

        function autoResizeTextarea(selector) {
            const textarea = document.querySelector(selector);
            if (!textarea) return;

            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                const maxHeight = 128; // ~5 lines
                textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
                textarea.style.overflowY = textarea.scrollHeight > maxHeight ? 'auto' : 'hidden';
            });
        }

        autoResizeTextarea("#chatInput");
        autoResizeTextarea("#newChatInput");


        // Toggle the sidebar open/close
        function toggleSidebar() {
            const sidebar = $("#sidebar");
            const mainContent = $("#mainContent");
            const toggleBtn = $("#sidebarToggleBtn");
            const closeBtn = $("#sidebarCloseBtn");

            sidebar.toggleClass("active");
            mainContent.toggleClass("shifted");
            toggleBtn.toggleClass("active");

            const isOpen = sidebar.hasClass("active");

            if (isOpen) {
                toggleBtn.hide();
                closeBtn.show();
                $("body").removeClass("sidebar-closed");
            } else {
                toggleBtn.show();
                closeBtn.hide();
                $("body").addClass("sidebar-closed");
            }
        }

        // Initialize sidebar based on window width
        function initSidebar() {
            const isDesktop = window.innerWidth >= 640;
            const sidebar = $("#sidebar");
            const mainContent = $("#mainContent");
            const toggleBtn = $("#sidebarToggleBtn");
            const closeBtn = $("#sidebarCloseBtn");

            if (isDesktop) {
                sidebar.addClass("active");
                mainContent.addClass("shifted");
                toggleBtn.addClass("active").hide();
                closeBtn.show();
                $("body").removeClass("sidebar-closed");
            } else {
                sidebar.removeClass("active");
                mainContent.removeClass("shifted");
                toggleBtn.removeClass("active").show();
                closeBtn.hide();
                $("body").addClass("sidebar-closed");
            }
        }

// ----------------------------------------



function processMarkdown(content) {

    // 🔧 Step 1: Convert bold-only lines into headings dynamically
    content = content.split('\n').map(line => {
        const boldHeadingMatch = line.trim().match(/^\*\*(.+?)\*\*$/);
        if (boldHeadingMatch) {
            return `## ${boldHeadingMatch[1].trim()}`;  // Convert to h2 heading
        }
        return line;
    }).join('\n');


    // Store original markdown content in a data attribute
    const container = document.createElement('div');
    container.className = 'markdown-body';
    container.dataset.originalMarkdown = content; // Store original markdown
    
    // Configure marked
    marked.setOptions({
        breaks: true,
        gfm: true,
        tables: true,
        highlight: function(code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
        }
    });

    // Sanitize and render markdown
    const dirty = marked.parse(content);
    const clean = DOMPurify.sanitize(dirty, {
        ALLOWED_TAGS: [
            'p', 'br', 'code', 'pre', 'span', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
            'ul', 'ol', 'li', 'strong', 'em', 'a', 'img', 'blockquote', 'table', 'thead',
            'tbody', 'tr', 'th', 'td', 'hr', 'del', 'ins', 'sup', 'sub'
        ],
        ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'style', 'data-original-markdown'],
    });

    container.innerHTML = clean;

    // Render LaTeX (MathJax)
    if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise([container]);
    }



    // Add event listener for copy events
    container.addEventListener('copy', function(e) {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        
        const range = selection.getRangeAt(0);
        const selectedContent = range.cloneContents();
        
        // Find if we're copying from a table or code block
        let copiedText = '';
        
        // Check if selection contains a table
        if (selectedContent.querySelector('table')) {
            const table = selectedContent.querySelector('table');
            const tableWrapper = table.closest('.table-scroll-wrapper');
            if (tableWrapper) {
                // Get the original markdown for this table
                const originalMarkdown = tableWrapper.dataset.originalMarkdown;
                if (originalMarkdown) {
                    copiedText = originalMarkdown;
                } else {
                    // Fallback to converting the HTML table to markdown
                    copiedText = convertTableToText(table);
                }
            }
        } 
        // Check if selection contains a code block
        else if (selectedContent.querySelector('pre')) {
            const pre = selectedContent.querySelector('pre');
            const code = pre.querySelector('code');
            if (code) {
                copiedText = code.textContent;
            }
        } 
        // For other content, try to get the original markdown
        else {
            // Find the nearest element with original markdown data
            let element = range.startContainer;
            while (element && element !== container) {
                if (element.dataset?.originalMarkdown) {
                    copiedText = element.dataset.originalMarkdown;
                    break;
                }
                element = element.parentNode;
            }
            
            // If no original markdown found, use the HTML content
            if (!copiedText) {
                const div = document.createElement('div');
                div.appendChild(selectedContent.cloneContents());
                copiedText = div.innerHTML;
            }
        }
        
        if (copiedText) {
            e.clipboardData.setData('text/plain', copiedText);
            e.clipboardData.setData('text/html', dirty); // Include HTML for rich text editors
            e.preventDefault();
        }
    });

    // Wrap tables and add copy buttons
    container.querySelectorAll("table").forEach(table => {
        const wrapper = document.createElement("div");
        wrapper.className = "table-scroll-wrapper";
        
        // Store original markdown for this table
        const tableMarkdown = extractTableMarkdown(content, table);
        wrapper.dataset.originalMarkdown = tableMarkdown;
        
        // Add copy button for table
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-table-btn';
        copyButton.textContent = 'Copy table';
        copyButton.onclick = () => {
            const tableText = tableMarkdown || convertTableToText(table);
            navigator.clipboard.writeText(tableText).then(() => {
                copyButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyButton.textContent = 'Copy table';
                }, 2000);
            });
        };
        
        table.parentNode.insertBefore(wrapper, table);
        wrapper.appendChild(table);
        wrapper.appendChild(copyButton);
    });

    container.querySelectorAll('pre > code').forEach(code => {
        const lang = code.className.split('-')[1] || 'code';

        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        wrapper.style.position = 'relative';
        wrapper.style.margin = '1em 0';

        // Top bar with language and copy button
        const bar = document.createElement('div');
        bar.className = 'code-block-header';
        bar.style.display = 'flex';
        bar.style.justifyContent = 'space-between';
        bar.style.alignItems = 'center';
        bar.style.backgroundColor = '#1e1e1e';
        bar.style.color = '#ccc';
        bar.style.fontSize = '0.8em';
        bar.style.padding = '4px 12px';
        bar.style.borderTopLeftRadius = '6px';
        bar.style.borderTopRightRadius = '6px';

        const langLabel = document.createElement('span');
        langLabel.textContent = lang.toUpperCase();

        const spacer = document.createElement('div');
        spacer.style.flex = '1';

        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copy';
        copyBtn.className = 'copy-code-btn';
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(code.innerText).then(() => {
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
            });
        };

        bar.appendChild(langLabel);
        bar.appendChild(spacer);
        bar.appendChild(copyBtn);

        const pre = code.parentNode;
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(bar);
        wrapper.appendChild(pre);
    });


    return container;
}

// Helper function to extract the original markdown for a table
function extractTableMarkdown(fullMarkdown, tableElement) {
    // This is a simplified approach - you might need a more robust solution
    const tableHtml = tableElement.outerHTML;
    const startIndex = fullMarkdown.indexOf('|');
    if (startIndex === -1) return null;
    
    let endIndex = startIndex;
    while (endIndex < fullMarkdown.length) {
        if (fullMarkdown.substring(endIndex).trim() === '') {
            break;
        }
        endIndex = fullMarkdown.indexOf('\n', endIndex + 1);
        if (endIndex === -1) {
            endIndex = fullMarkdown.length;
            break;
        }
    }
    
    return fullMarkdown.substring(startIndex, endIndex).trim();
}

// Function to convert HTML table to plain text format (markdown)
function convertTableToText(table) {
    let result = '';
    const rows = table.querySelectorAll('tr');
    
    // Determine column widths
    const colWidths = [];
    rows.forEach(row => {
        const cells = row.querySelectorAll('th, td');
        cells.forEach((cell, i) => {
            const cellText = cell.textContent.trim();
            const textLength = cellText.length;
            colWidths[i] = Math.max(colWidths[i] || 0, textLength);
        });
    });
    
    // Build the table content
    rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('th, td');
        let rowText = '|';
        
        cells.forEach((cell, i) => {
            let cellText = cell.textContent.trim();
            // Preserve markdown bold syntax if present in HTML
            if (cell.querySelector('strong') || cell.querySelector('b')) {
                cellText = `**${cellText}**`;
            }
            
            const padding = ' '.repeat(Math.max(0, colWidths[i] - cellText.length));
            rowText += ' ' + cellText + padding + ' |';
        });
        
        result += rowText + '\n';
        
        // Add separator line after header
        if (rowIndex === 0 && row.querySelector('th')) {
            let separator = '|';
            colWidths.forEach(width => {
                separator += ' ' + '-'.repeat(width + 2) + ' |';
            });
            result += separator + '\n';
        }
    });
    
    return result;
}




function attachCopyButton(messageId, position = "right") {
    const copyBtn = `
        <div class="copy-btn-container ${position}">
            <button class="copy-btn" data-target="${messageId}" title="Copy text">
                <svg><use href="#copy-icon"></use></svg>
            </button>
        </div>
    `;

    const targetElement = $(`#${messageId}`);
    targetElement.after(copyBtn);

    $(`button[data-target="${messageId}"]`).on("click", function () {
        const button = $(this);
        const el = document.getElementById(messageId);

        if (!el) return;

        // Create a selection range
        const range = document.createRange();
        range.selectNodeContents(el);

        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        try {
            const htmlContent = el.innerHTML;
            const plainText = el.innerText;

            // Write to clipboard with both HTML and plain text
            navigator.clipboard.write([
                new ClipboardItem({
                    "text/plain": new Blob([plainText], { type: "text/plain" }),
                    "text/html": new Blob([htmlContent], { type: "text/html" })
                })
            ]).then(() => {
                button.addClass("copied");
                button.find("use").attr("href", "#check-icon");
                setTimeout(() => {
                    button.removeClass("copied");
                    button.find("use").attr("href", "#copy-icon");
                }, 2000);
            });
        } catch (err) {
            console.error("Copy failed:", err);
        }

        // Cleanup
        selection.removeAllRanges();
    });
}



        // Improved scrollToBottom with auto-scroll logic
        function scrollToBottom() {
            if (!userScrolledUp && !isUserInteractingWithScroll) {
                const chatContainer = document.getElementById('msg-container-box');
                // Small delay to ensure DOM is updated
                setTimeout(() => {
                    chatContainer.scrollTo({
                        top: chatContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 50);
            }
        }
// ----------------------------------------



        // DOM Ready
        $(document).ready(function () {
            // Initialize on load
            initSidebar();

            // Button click events
            $("#sidebarToggleBtn, #sidebarCloseBtn").on("click", toggleSidebar);

            // Window resize behavior
            $(window).on("resize", initSidebar);

            // Your other logic (chat actions, input, etc.)
            $(document).on("click", ".more-btn", function (e) {
                e.stopPropagation();
                $(".action-menu").not($(this).siblings(".action-menu")).hide();
                $(this).siblings(".action-menu").toggle();
            });

            $(document).on("click", function () {
                $(".action-menu").hide();
            });

            $(document).on("click", ".delete-history", function (e) {
                e.stopPropagation();
                $(this).closest(".chat-history-item").remove();
            });

            $("#chatSearch").on("input", function () {
                const val = $(this).val().toLowerCase();
                const chats = $("#chatHistory .chat-history-item");
                chats.each(function () {
                    const text = $(this).find("span").text().toLowerCase();
                    $(this).toggle(text.includes(val));
                });
                const visibleChats = chats.filter(function () {
                    return $(this).css("display") !== "none";
                });
                visibleChats.prependTo("#chatHistory");
            });





            // --------------------------------------
            // Submit message on Enter, allow Shift+Enter
            function handleKeyPress(inputSelector, buttonSelector) {
                $(inputSelector).on("keydown", function (e) {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        $(buttonSelector).click();
                    }
                });
            }

            handleKeyPress("#chatInput", "#submitMessage");
            handleKeyPress("#newChatInput", "#sendMessage");


// ----------------------------------------------------------

    // Initialize highlight.js
    hljs.highlightAll();

setupAutoScroll();


// Track if we're currently streaming a response
let isStreamingResponse = false;
let currentBotResponseId = null;

// Common function to handle both submit buttons
function handleChatSubmit(message, inputSelector) {
    if (!message || isStreamingResponse) return;

        userScrolledUp = false; // <- reset on new message


    // Hide initial section if visible
    if (!$("#initialChatSection").hasClass("hidden")) {
        $("#initialChatSection").addClass("hidden");
        $("#chatContainer").removeClass("hidden");
    }

    // Append user message
    appendMessage("user", message);
    $(inputSelector).val("").css("height", "auto");

    // Create a new empty bot response div
    currentBotResponseId = "bot-response-" + Date.now();
    // $("#chatMessages").append(`<div id="${currentBotResponseId}" class="chat-message chat-gpt"></div>`);

    $("#chatMessages").append(`
    <div id="${currentBotResponseId}" class="chat-message chat-gpt">
        <div class="loader-dots">
            <span></span><span></span><span></span>
        </div>
    </div>
    `);

    scrollToBottom();
    
    isStreamingResponse = true;
    let buffer = '';
    

// Update your fetch handler with this optimized version
fetch('chat/', {
    method: 'POST',
    body: new URLSearchParams({ message: message }),
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
    }
}).then(response => {
    const reader = response.body.getReader();
    const decoder = new TextDecoder('utf-8');
    let buffer = '';
    let lastRenderTime = 0;
    const renderInterval = 200;

    function readStream() {
        return reader.read().then(({ done, value }) => {
            if (done) {
                if (buffer.trim()) {
                    const container = processMarkdown(buffer);
                    if (container) {
                        $(`#${currentBotResponseId}`).html(container);

                        attachCopyButton(currentBotResponseId, "left");  // ✅ Cleaner

                        hljs.highlightAll();
                    }
                }
                isStreamingResponse = false;
                scrollToBottom();
                return;
            }
            
            const chunk = decoder.decode(value, { stream: true });
            buffer += chunk;
            
            const now = Date.now();
            if (now - lastRenderTime > renderInterval || chunk.includes('\n')) {
                const container = processMarkdown(buffer);
                if (container) {
                    $(`#${currentBotResponseId}`).html(container);
                    hljs.highlightAll();
                    lastRenderTime = now;
                    scrollToBottom();
                }
            }
            
            return readStream();
        });
    }

    return readStream();
}).catch(err => {
    isStreamingResponse = false;
    $(`#${currentBotResponseId}`).html(`<div class="markdown-body">Error: ${err.message}</div>`);
    scrollToBottom();
});



}



// Update your click handlers
$("#submitMessage").on("click", function() {
    handleChatSubmit($("#chatInput").val().trim(), "#chatInput");
});

$("#sendMessage").on("click", function() {
    handleChatSubmit($("#newChatInput").val().trim(), "#newChatInput");
});


// Helper functions
function appendMessage(sender, text) {
    const msgClass = sender === "user" ? "chat-user" : "chat-gpt";
    const containerClass = sender === "user" ? "user-message-container" : "bot-message-container";
    const messageId = "msg-" + Date.now();

    const content = `
        <div class="${containerClass}">
            <div class="chat-message ${msgClass}" id="${messageId}"></div>
        </div>
    `;

    $("#chatMessages").append(content);

    if (sender === "user") {
        $(`#${messageId}`).text(text);
        attachCopyButton(messageId, "right");

    } else {
        const container = processMarkdown(text);
        $(`#${messageId}`).append(container);
        attachCopyButton(messageId, "left");
    }


    scrollToBottom();
}




// ----------------------------------------------------------



        });
    </script>
</body>

</html>